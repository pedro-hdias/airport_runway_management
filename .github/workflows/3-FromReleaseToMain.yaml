name: Release to Main PR Creation

on:
  pull_request:
    types: [closed]
    branches:
      - release-*  # Dispara o workflow quando um PR da branch release Ã© fechado

jobs:
  create_release_pr:
    if: github.event.pull_request.merged == true  # Somente continua se o PR foi mergeado
    runs-on: ubuntu-latest

    steps:
      # Checkout the release branch
      - name: Checkout release branch
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      # Check for an existing PR from release to main
      - name: Check for existing PR from release to main
        id: check_pr
        run: |
          pr_exists=$(gh pr list --base main --head ${{ github.event.pull_request.head.ref }} --state open --json number --jq '.[0].number')
          if [[ -z "$pr_exists" ]]; then
            echo "No PR found. Creating a new one."
            echo "create_pr=true" >> $GITHUB_ENV
          else
            echo "PR already exists: #$pr_exists"
            echo "create_pr=false" >> $GITHUB_ENV
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Create PR if no existing PR is found
      - name: Create Pull Request from release to main
        if: env.create_pr == 'true'
        run: |
          gh pr create \
            --head ${{ github.event.pull_request.head.ref }} \
            --base main \
            --title "Merge Release Branch ${{ github.event.pull_request.head.ref }} into Main" \
            --body "This PR merges the release branch ${{ github.event.pull_request.head.ref }} into the main branch." \
            --label "release"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
